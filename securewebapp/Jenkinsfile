pipeline {
    agent any

    stages {

        stage('Build') {
            steps {
                echo 'Installing dependencies...'
                sh '''
                sudo apt-get update -y
                sudo apt-get install -y php php-cli php-mbstring php-xml php-zip unzip composer
                composer install
                '''
            }
        }

        stage('Test') {
            steps {
                echo 'Running PHPUnit tests...'
                sh '''
                if [ -f vendor/bin/phpunit ]; then
                    ./vendor/bin/phpunit --log-junit test-report.xml || true
                else
                    echo "PHPUnit not found â€” skipping tests."
                fi
                '''
            }
            post {
                always {
                    junit 'test-report.xml'
                }
            }
        }

        stage('Code Quality') {
            steps {
                echo 'Running SonarCloud analysis...'
                withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
                    sh '''
                    sonar-scanner \
                    -Dsonar.projectKey=Secure_Webapp \
                    -Dsonar.organization=namanshahnemi-rgb \
                    -Dsonar.host.url=https://sonarcloud.io \
                    -Dsonar.login=$SONAR_TOKEN
                    '''
                }
            }
        }

        stage('Security') {
            steps {
                echo 'Running Trivy filesystem scan...'
                sh '''
                sudo apt-get install -y wget
                wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_Linux-64bit.deb
                sudo dpkg -i trivy_Linux-64bit.deb
                trivy fs --severity HIGH,CRITICAL --exit-code 0 .
                '''
            }
        }
    }
}
